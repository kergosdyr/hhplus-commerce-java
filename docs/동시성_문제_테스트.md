# 동시성 문제 테스트

## 동시성 제어 방식의 선택

- 앞선 이해 과정에서 알아본 동시성 로직 중 주어진 과제에 맞게 구축하려면 몇가지 방식으로 구축할 수 있습니다.
- DB의 비관적 락을 사용한 구현, Redis 로 구현하는 분산 락 그중에서도 Lettuce(spin lock) 혹은 Redisson(pub-sub) 을 사용한 구현 3가지 정도로 실제 성능 테스트를
  진행하였습니다.

## 가설

- DB Lock 의 경우 현재 잡은 커넥션 풀 사이즈가 그렇게 크지않고, 성능테스트를 위한 요청 역시 동시에 300개 정도로 크게 잡지 않았으므로 준수한 성능이 나올것이다.
- Lettuce(spin lock) 의 경우 현재 코드에서 retry interval 을 일정 시간 두었기 때문에 성능적으로 가장 좋지않을 것이다.
- Redisson(pub-sub) 의 경우 pub-sub 방식을 사용해서 lettuce 보다 좀더 높은 성능을 낼 것이고 성능상으로도 가장 좋을 것이다.

## 성능 테스트 환경

- K6로 성능 테스트를 진행하였으며 유저는 총 300명이 동시에 쿠폰을 발급하고, 모든 발급이 끝난 뒤 주문을 하는 식으로 성능테스트를 진행하였습니다.
- 쿠폰 발급 및 주문은 0.1 초의 간격으로 모든 요청을 발생시켰습니다.

## 검증

1. DB 비관적 락

- 평균 요청 시간은 약 2.39s 이며 p95의 경우 6.56s 였습니다.

2. Redis-Lettuce(spin-lock)

- 평균 요청 시간은 약 5.21s 이며 p95의 경우 **20.99s** 였습니다.

3. Redis-redisson(pub-sub)

- 평균 요청 시간은 약 4.15s 이며 p95의 경우 **11.36s** 였습니다.

## 결론

- 기본적으로 커넥션 풀이 마르지 않는 상황에서는 DB 비관적 Lock 의 성능이 조금 더 우수하다고 볼 수 있습니다.
- 다만, 커넥션 풀이 마르거나 데드락이 발생하는 경우는 서비스의 대규모적인 장애로 이어질 수 있기 때문에 위와같은 간단한 성능테스트 결과로 DB Lock 을 선택하기는 어렵습니다.
- Redis 역시 SPOF 인 문제가 있지만, 이는 레디스 클러스터 등으로 극복 가능함. 또한 다중 인스턴스 환경에서 같은 Lock 이 필요한 경우에도 제공 가능합니다.
- lettuce, redisson 두 클라이언트의 성능 문제에서는 단순 요청 시간으로만 비교하더라도 redisson 이 훨씬 우수한 걸 알수 있었습니다.
- 특히, p95의 경우 lettuce 는 20s 으로 실제 서비스에서는 충분한 문제로 이어질 수 있습니다.
- 따라서, 현재 과제를 고가용성이 요구되는 시스템이라고 가정할 때, redisson 을 채택하는 것이 상대적으로 합리적인 선택입니다. 